#!/bin/sh
# description "fetch SSH keys"
# author "Scaleway <opensource@scaleway.com>"
# source "https://github.com/scaleway/image-tools/blob/master/skeleton-common/usr/local/sbin/scw-fetch-ssh-keys"

set -e

ssh_dir="$HOME/.ssh"
authorized_keys="$ssh_dir/authorized_keys"
instance_keys="$ssh_dir/instance_keys"

# ensure ~ has the correct permissions
chown "$(id -nu):$(id -ng)" "$HOME"
chmod 700 "$HOME"

# ensure ~/.ssh exists and has correct permissions
mkdir -p "$ssh_dir"
chown "$(id -nu):$(id -ng)" "$ssh_dir"
chmod 700 "$ssh_dir"

# `--upgrade` refreshes the metadata cache
if [ "$1" = "--upgrade" ]; then
	/usr/local/bin/scw-metadata > /dev/null
fi

cat << EOF > "$authorized_keys"
#
# WARNING: Automatically generated file
# This file will be erased at every boot
# This file was generated with '/usr/local/sbin/scw-fetch-ssh-keys'
#
# To add a new key, you can:
#   -- Add keys on your Scaleway account https://cloud.scaleway.com/#/credentials
#   -- Add keys using server tags - https://cloud.scaleway.com/#/servers/$(scw-metadata --cached ID)
#        - i.e: "AUTHORIZED_KEY=ssh-rsa_XXXXXXXXXXX AUTHORIZED_KEY=ssh-rsa_YYYYYYYYYYYYYYY"
#        - Be sure to replace all spaces with underscores
#        - $> sed 's/ /_/g' ~/.ssh/id_rsa.pub
#   -- Add the keys to '~/.ssh/instance_keys' which will be imported
#
# And recreate your 'authorized_keys' file with the new keys:
#   -- Run 'scw-fetch-ssh-keys --upgrade'
#
EOF

# add Scaleway account keys
/usr/local/bin/scw-metadata --cached | grep SSH_PUBLIC_KEYS_.*_KEY | cut -d'=' -f 2- | tr -d \' >> "$authorized_keys"

# add Server tags keys
/usr/local/bin/scw-metadata --cached | grep TAGS_.*=AUTHORIZED_KEY | cut -d'=' -f 3- | sed 's/_/\ /g' >> "$authorized_keys"

# Import custom keys
if [ -f "$instance_keys" ]; then
	cat << EOF >> "$authorized_keys"
# Below your custom ssh keys from '$instance_keys'
EOF
	(cat "$instance_keys" | grep -v "^#" || true) >> "$authorized_keys"
fi

# authorized_keys should only be readable by the owner and no one else
chmod 0600 "$authorized_keys"
